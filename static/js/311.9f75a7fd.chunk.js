"use strict";(self.webpackChunkgamehubpayment=self.webpackChunkgamehubpayment||[]).push([[311],{6311:(e,t,s)=>{s.d(t,{default:()=>r});var o=s(2962);const r=new class{constructor(){this.accessToken=null,this.currentUser=null,this.fslAuth=null,this.isInitialized=!1,this.isDevelopment="localhost"===window.location.hostname,this.FSL_OAUTH_URL="https://9ijsflpfgm3.joysteps.io/api/account/oauth/authorize",this.FSL_USER_PROFILE_URL="https://9ijsflpfgm3.joysteps.io/api/account/party/user",this.APP_KEY="MiniGame",this.REDIRECT_URI=window.location.href}async authenticateWithOAuth(){try{console.log("\ud83d\udd04 Starting OAuth authentication...");const e=new URLSearchParams({response_type:"token",appkey:this.APP_KEY,redirect_uri:encodeURIComponent(this.REDIRECT_URI),scope:"basic",state:"test"}),t=`${this.FSL_OAUTH_URL}?${e.toString()}`;console.log("\ud83d\udd17 OAuth URL:",t),window.location.href=t}catch(e){throw console.error("\u274c OAuth authentication failed:",e),e}}handleOAuthCallback(){try{console.log("\ud83d\udd04 Handling OAuth callback...");const e=window.location.hash.substring(1),t=new URLSearchParams(e);this.accessToken=t.get("access_token");const s=t.get("state"),o=t.get("error");if(console.log("\ud83d\udd0d OAuth callback params:",{accessToken:!!this.accessToken,state:s,error:o}),o)throw new Error(`OAuth error: ${o}`);if(!this.accessToken)throw new Error("No access token received from OAuth");return localStorage.setItem("fsl_access_token",this.accessToken),localStorage.setItem("fsl_oauth_timestamp",Date.now().toString()),console.log("\u2705 OAuth callback successful, access token stored"),{success:!0,accessToken:this.accessToken,state:s}}catch(e){return console.error("\u274c OAuth callback handling failed:",e),{success:!1,error:e.message}}}async getAccessToken(){try{const e=localStorage.getItem("fsl_access_token"),t=localStorage.getItem("fsl_oauth_timestamp");if(e&&t){const s=Date.now()-parseInt(t);if(s<864e5)return this.accessToken=e,console.log("\u2705 Using stored access token"),this.accessToken;console.log("\u26a0\ufe0f Access token expired, clearing..."),this.clearStoredTokens()}console.log("\ud83d\udd04 No valid access token, redirecting to OAuth..."),await this.authenticateWithOAuth()}catch(e){throw console.error("\u274c Failed to get access token:",e),e}}clearStoredTokens(){localStorage.removeItem("fsl_access_token"),localStorage.removeItem("fsl_oauth_timestamp"),this.accessToken=null,console.log("\ud83d\uddd1\ufe0f Stored tokens cleared")}async verifyUserIdentity(){try{var e,t;if(console.log("\ud83d\udd0d Verifying user identity..."),!this.accessToken)throw new Error("No access token available");const s=await this.getFSLUserProfile();console.log("\ud83d\udcca FSL User Profile:",s);const o=await this.getMarketUserData();console.log("\ud83d\udcca Market User Data:",o);const r=(null===(e=s.data)||void 0===e?void 0:e.fslUid)||(null===(t=s.data)||void 0===t?void 0:t.uid),a=o.fslId;if(console.log("\ud83d\udd0d Comparing FSL IDs:"),console.log("  FSL API FSL ID:",r),console.log("  Market API FSL ID:",a),!r||!a)throw new Error("Missing FSL ID from one or both sources");const c=r.toString()===a.toString();if(console.log("\u2705 FSL ID match:",c),c)return this.currentUser={fslId:r,fslProfile:s.data,marketProfile:o,isVerified:!0,verifiedAt:(new Date).toISOString()},console.log("\u2705 User identity verified:",this.currentUser),{success:!0,user:this.currentUser,fslId:r};throw new Error("FSL ID mismatch. User may be logged into different account.")}catch(s){return console.error("\u274c User identity verification failed:",s),{success:!1,error:s.message}}}async getFSLUserProfile(){try{console.log("\ud83d\udce1 Getting FSL user profile..."),console.log("\ud83d\udd17 API URL:",this.FSL_USER_PROFILE_URL),console.log("\ud83d\udd11 Access Token:",this.accessToken),console.log("\ufffd\ufffd Request Headers:",{Authorization:`Bearer ${this.accessToken}`});const e=await fetch(this.FSL_USER_PROFILE_URL,{method:"GET",method:"cors",headers:{Authorization:`Bearer ${this.accessToken}`}});if(!e.ok)throw new Error(`FSL API error: ${e.status} ${e.statusText}`);const t=await e.json();return console.log("\u2705 FSL user profile received:",t),t}catch(e){throw console.error("\u274c Failed to get FSL user profile:",e),e}}async getMarketUserData(){try{console.log("\ud83d\udce1 Getting market user data...");const e=await fetch(`${o.i3.server_url}/api/app/marketUserData`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`Market API error: ${e.status} ${e.statusText}`);const t=await e.json();return console.log("\u2705 Market user data received:",t),t}catch(e){throw console.error("\u274c Failed to get market user data:",e),e}}isUserAuthenticated(){var e;return!(!this.accessToken||null===(e=this.currentUser)||void 0===e||!e.isVerified)}getCurrentUser(){return this.currentUser}getAccessTokenForFSL(){return this.accessToken}logout(){this.clearStoredTokens(),this.currentUser=null,this.fslAuth=null,this.isInitialized=!1,console.log("\u2705 User logged out successfully")}}}}]);
//# sourceMappingURL=311.9f75a7fd.chunk.js.map