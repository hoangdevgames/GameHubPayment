"use strict";(self.webpackChunkgamehubpayment=self.webpackChunkgamehubpayment||[]).push([[311],{6311:(t,e,s)=>{s.d(e,{default:()=>c});var o=s(3684),a=s(6283),n=s(3064),r=s(4522),i=s(2962);const c=new class{constructor(){this.accessToken=null,this.currentUser=null,this.fslAuth=null,this.isInitialized=!1,this.isDevelopment="localhost"===window.location.hostname,this.FSL_OAUTH_URL="https://id.fsl.com/api/account/oauth/authorize",this.FSL_USER_PROFILE_URL="https://id.fsl.com/api/account/party/user",this.APP_KEY="MiniGame",this.REDIRECT_URI=window.location.origin+window.location.pathname,this.GGUSD_CONTRACTS={137:"0xFFFFFF9936BD58a008855b0812B44D2c8dFFE2aA",56:"0xffffff9936bd58a008855b0812b44d2c8dffe2aa",80002:"0xfF39ac1e2aD4CbA1b86D77d972424fB8515242bd"},this.CHAIN_NAMES={80002:"Amoy",137:"Polygon",56:"BSC"},this.FSL_CHAIN_MAPPING={80002:"polygon",137:"polygon",56:"bsc"},this.RPC_URLS={80002:"https://rpc-amoy.polygon.technology/",137:"https://polygon-rpc.com/",56:"https://bsc-dataseed.binance.org/"}}async authenticateWithOAuth(){try{console.log("\ud83d\udd04 Starting OAuth authentication...");const t=new URLSearchParams({response_type:"token",appkey:this.APP_KEY,redirect_uri:encodeURIComponent(this.REDIRECT_URI),scope:"basic,wallet,stepn",state:"gamehub_payment"}),e=`${this.FSL_OAUTH_URL}?${t.toString()}`;console.log("\ud83d\udd17 OAuth URL:",e),window.location.href=e}catch(t){throw console.error("\u274c OAuth authentication failed:",t),t}}handleOAuthCallback(){try{console.log("\ud83d\udd04 Handling OAuth callback...");const t=window.location.hash.substring(1),e=new URLSearchParams(t);this.accessToken=e.get("access_token");const s=e.get("state"),o=e.get("error");if(console.log("\ud83d\udd0d OAuth callback params:",{accessToken:!!this.accessToken,state:s,error:o}),o)throw new Error(`OAuth error: ${o}`);if(!this.accessToken)throw new Error("No access token received from OAuth");return localStorage.setItem("fsl_access_token",this.accessToken),localStorage.setItem("fsl_oauth_timestamp",Date.now().toString()),console.log("\u2705 OAuth callback successful, access token stored"),{success:!0,accessToken:this.accessToken,state:s}}catch(t){return console.error("\u274c OAuth callback handling failed:",t),{success:!1,error:t.message}}}async getAccessToken(){try{const t=localStorage.getItem("fsl_access_token"),e=localStorage.getItem("fsl_oauth_timestamp");if(t&&e){const s=Date.now()-parseInt(e);if(s<864e5)return this.accessToken=t,console.log("\u2705 Using stored access token"),this.accessToken;console.log("\u26a0\ufe0f Access token expired, clearing..."),this.clearStoredTokens()}console.log("\ud83d\udd04 No valid access token, redirecting to OAuth..."),await this.authenticateWithOAuth()}catch(t){throw console.error("\u274c Failed to get access token:",t),t}}clearStoredTokens(){localStorage.removeItem("fsl_access_token"),localStorage.removeItem("fsl_oauth_timestamp"),this.accessToken=null,console.log("\ud83d\uddd1\ufe0f Stored tokens cleared")}async verifyUserIdentity(){try{var t,e;if(console.log("\ud83d\udd0d Verifying user identity..."),!this.accessToken)throw new Error("No access token available");const s=await this.getFSLUserProfile();console.log("\ud83d\udcca FSL User Profile:",s);const o=await this.getMarketUserData();console.log("\ud83d\udcca Market User Data:",o);const a=(null===(t=s.data)||void 0===t?void 0:t.fslUid)||(null===(e=s.data)||void 0===e?void 0:e.uid),n=o.fslId;if(console.log("\ud83d\udd0d Comparing FSL IDs:"),console.log("  FSL API FSL ID:",a),console.log("  Market API FSL ID:",n),!a||!n)throw new Error("Missing FSL ID from one or both sources");const r=a.toString()===n.toString();if(console.log("\u2705 FSL ID match:",r),r)return this.currentUser={fslId:a,fslProfile:s.data,marketProfile:o,isVerified:!0,verifiedAt:(new Date).toISOString()},console.log("\u2705 User identity verified:",this.currentUser),{success:!0,user:this.currentUser,fslId:a};throw new Error("FSL ID mismatch. User may be logged into different account.")}catch(s){return console.error("\u274c User identity verification failed:",s),{success:!1,error:s.message}}}async getFSLUserProfile(){try{console.log("\ud83d\udce1 Getting FSL user profile...");const t=await fetch(this.FSL_USER_PROFILE_URL,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error(`FSL API error: ${t.status} ${t.statusText}`);const e=await t.json();return console.log("\u2705 FSL user profile received:",e),e}catch(t){throw console.error("\u274c Failed to get FSL user profile:",t),t}}async getMarketUserData(){try{console.log("\ud83d\udce1 Getting market user data...");const t=await fetch(`${i.i3.server_url}/api/app/marketUserData`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Market API error: ${t.status} ${t.statusText}`);const e=await t.json();return console.log("\u2705 Market user data received:",e),e}catch(t){throw console.error("\u274c Failed to get market user data:",t),t}}async initFSLSDK(){try{if(console.log("\ud83d\udd04 Initializing FSL SDK with access token..."),!this.accessToken)throw new Error("No access token available for FSL SDK initialization");if(this.isInitialized&&this.fslAuth)return console.log("\u2705 FSL SDK already initialized"),this.fslAuth;const t={accessToken:this.accessToken,appKey:this.APP_KEY,redirectUri:this.REDIRECT_URI,scope:"basic,wallet,stepn",state:"gamehub_payment",usePopup:!0,isApp:!1,domain:"https://9ijsflpfgm3.joysteps.io"};return console.log("\ud83d\udd27 FSL SDK init options:",t),this.fslAuth=await o.A.init(t),this.isInitialized=!0,console.log("\u2705 FSL SDK initialized successfully with access token"),this.fslAuth}catch(t){throw console.error("\u274c FSL SDK initialization failed:",t),t}}async processPayment(t,e){try{console.log("\ud83d\udcb0 Processing payment with FSL SDK..."),console.log("\ud83d\udcca Purchase Data:",t),console.log("\ud83d\udd17 Chain ID:",e);const s=await this.verifyUserIdentity();if(!s.success)throw new Error(`User verification failed: ${s.error}`);await this.initFSLSDK();const o=await this.callEvmContractByCallDataWithCustomData(t,e,t.customData||"0x");return console.log("\u2705 Payment processed successfully:",o),o}catch(s){return console.error("\u274c Payment processing failed:",s),{success:!1,error:s.message}}}async callEvmContractByCallDataWithCustomData(t,e,s){try{console.log("\ud83d\udd17 Processing custom data transaction..."),console.log("\ud83d\udcca Purchase Data:",t),console.log("\ud83d\udd17 Chain ID:",e),console.log("\ud83d\udcdd Custom Data:",s);const o=this.GGUSD_CONTRACTS[e],i=this.getTreasuryAddress(e);if(!o||!i)throw new Error(`Unsupported chain ID: ${e}`);const c=t.price||t.ggusdAmount||1,l=new(new r.Ay$(this.RPC_URLS[e]).eth.Contract)(this.GGUSD_ABI,o),h=await l.methods.decimals().call(),u=Number(h.toString()),g=a.XS(c.toString(),u).toString();console.log("\ud83d\udcb0 Transaction Details:"),console.log("  Contract Address:",o),console.log("  Treasury Address:",i),console.log("  Amount (GGUSD):",c),console.log("  Amount (Wei):",g),console.log("  Custom Data Length:",s.length);const d="0xa9059cbb"+n.y.defaultAbiCoder().encode(["address","uint256"],[i,g]).slice(2)+s.slice(2);console.log("\ud83d\udd17 Final CallData:",d);const p=await this.initFSLSDK(),m=await p.callEvmContractByCallData({contractAddress:o,callData:d,chainId:e,gasLimit:"200000",chain:this.FSL_CHAIN_MAPPING[e],rpc:this.RPC_URLS[e]});return console.log("\u2705 Custom data transaction successful:",m),{success:!0,transactionHash:m.transactionHash||m.hash||"mock_tx_hash",amount:c,currency:"GGUSD",chain:this.getChainName(e),starletAmount:t.quantity||1,timestamp:(new Date).toISOString(),customData:s,network:this.getChainName(e)}}catch(o){return console.error("\u274c Custom data transaction failed:",o),o.message&&o.message.includes("pop-up cannot be ejected")?(console.warn("\ud83d\udeab Popup blocked! Please allow popups for this site."),{success:!1,error:"Payment popup was blocked. Please allow popups for this site and try again.",originalError:o.message}):{success:!1,error:o.message,chain:this.getChainName(e)}}}getChainName(t){return this.CHAIN_NAMES[t]||"Unknown"}getTreasuryAddress(t){return"0x1a7dabEfb9D1fD8BF3197d61C0D6aa8ef3948fEb"}get GGUSD_ABI(){return[{constant:!1,inputs:[{name:"_to",type:"address"},{name:"_value",type:"uint256"}],name:"transfer",outputs:[{name:"",type:"bool"}],payable:!1,stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"_owner",type:"address"}],name:"balanceOf",outputs:[{name:"balance",type:"uint256"}],payable:!1,stateMutability:"view",type:"function"},{constant:!0,inputs:[],name:"decimals",outputs:[{name:"",type:"uint8"}],payable:!1,stateMutability:"view",type:"function"}]}isUserAuthenticated(){var t;return!(!this.accessToken||null===(t=this.currentUser)||void 0===t||!t.isVerified)}getCurrentUser(){return this.currentUser}logout(){this.clearStoredTokens(),this.currentUser=null,this.fslAuth=null,this.isInitialized=!1,console.log("\u2705 User logged out successfully")}}}}]);
//# sourceMappingURL=311.a7b6e740.chunk.js.map