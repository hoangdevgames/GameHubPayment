<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSL OAuth Callback</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .callback-container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            margin: 1rem 0;
            font-size: 1.1rem;
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .retry-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
            transition: background 0.3s;
        }
        .retry-btn:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="spinner"></div>
        <div class="status" id="status">Processing OAuth callback...</div>
        <div id="message"></div>
        <button class="retry-btn" id="retryBtn" style="display: none;" onclick="retryAuthentication()">
            Try Again
        </button>
    </div>

    <script>
        // OAuth callback handler
        async function handleOAuthCallback() {
            try {
                console.log('üîÑ Handling OAuth callback...');
                
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                
                // Check for OAuth response in hash (implicit flow)
                const accessToken = hashParams.get('access_token');
                const state = hashParams.get('state');
                const error = hashParams.get('error');
                const errorDescription = hashParams.get('error_description');
                
                console.log('üîç OAuth callback parameters:', {
                    hasAccessToken: !!accessToken,
                    state: state,
                    error: error,
                    errorDescription: errorDescription
                });
                
                if (error) {
                    throw new Error(`OAuth Error: ${error}${errorDescription ? ` - ${errorDescription}` : ''}`);
                }
                
                if (!accessToken) {
                    throw new Error('No access token received from OAuth');
                }
                
                // Store access token
                localStorage.setItem('fsl_access_token', accessToken);
                localStorage.setItem('fsl_oauth_timestamp', Date.now().toString());
                localStorage.setItem('fsl_oauth_state', state || 'gamehub_payment');
                
                console.log('‚úÖ OAuth callback successful, access token stored');
                
                // Show success message
                document.getElementById('status').textContent = 'Authentication successful!';
                document.getElementById('message').innerHTML = `
                    <div class="success">
                        ‚úÖ Successfully authenticated with FSL ID<br>
                        Redirecting to main application...
                    </div>
                `;
                
                // Redirect back to main app after a short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå OAuth callback handling failed:', error);
                
                // Show error message
                document.getElementById('status').textContent = 'Authentication failed';
                document.getElementById('message').innerHTML = `
                    <div class="error">
                        ‚ùå ${error.message}<br>
                        Please try again or contact support.
                    </div>
                `;
                
                // Show retry button
                document.getElementById('retryBtn').style.display = 'inline-block';
            }
        }
        
        // Retry authentication
        function retryAuthentication() {
            console.log('üîÑ Retrying authentication...');
            
            // Clear any stored tokens
            localStorage.removeItem('fsl_access_token');
            localStorage.removeItem('fsl_oauth_timestamp');
            localStorage.removeItem('fsl_oauth_state');
            
            // Redirect back to main app to restart OAuth flow
            window.location.href = '/';
        }
        
        // Handle page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ OAuth callback page loaded');
            
            // Check if we're in an iframe (popup mode)
            if (window.opener) {
                console.log('üì± Popup mode detected, sending message to parent');
                
                try {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const accessToken = hashParams.get('access_token');
                    const state = hashParams.get('state');
                    const error = hashParams.get('error');
                    
                    if (accessToken) {
                        // Send success message to parent
                        window.opener.postMessage({
                            type: 'fsl_oauth_success',
                            accessToken: accessToken,
                            state: state
                        }, '*');
                        
                        // Close popup
                        window.close();
                    } else if (error) {
                        // Send error message to parent
                        window.opener.postMessage({
                            type: 'fsl_oauth_error',
                            error: error,
                            errorDescription: hashParams.get('error_description')
                        }, '*');
                        
                        // Close popup
                        window.close();
                    }
                } catch (error) {
                    console.error('‚ùå Error handling popup callback:', error);
                    window.close();
                }
            } else {
                // Regular page mode, handle normally
                handleOAuthCallback();
            }
        });
        
        // Handle messages from popup (if this page is the parent)
        window.addEventListener('message', (event) => {
            console.log('üì® Received message:', event.data);
            
            if (event.data.type === 'fsl_oauth_success') {
                console.log('‚úÖ OAuth success message received from popup');
                
                // Store access token
                localStorage.setItem('fsl_access_token', event.data.accessToken);
                localStorage.setItem('fsl_oauth_timestamp', Date.now().toString());
                localStorage.setItem('fsl_oauth_state', event.data.state || 'gamehub_payment');
                
                // Redirect to main app
                window.location.href = '/';
            } else if (event.data.type === 'fsl_oauth_error') {
                console.error('‚ùå OAuth error message received from popup:', event.data.error);
                
                // Show error and retry button
                document.getElementById('status').textContent = 'Authentication failed';
                document.getElementById('message').innerHTML = `
                    <div class="error">
                        ‚ùå OAuth Error: ${event.data.error}<br>
                        ${event.data.errorDescription ? event.data.errorDescription : ''}<br>
                        Please try again.
                    </div>
                `;
                
                document.getElementById('retryBtn').style.display = 'inline-block';
            }
        });
    </script>
</body>
</html>
